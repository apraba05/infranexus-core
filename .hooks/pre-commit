#!/bin/sh
# Simple secret detection pre-commit hook
echo "Running pre-commit secret scan..."

# Check if any .env file is being committed (that is not an .example)
if git diff --cached --name-only | grep -E '\.env' | grep -v '\.example$'; then
  echo "ERROR: Attempting to commit an .env file. Please use .env.example instead."
  exit 1
fi

# Basic grep for common secret patterns in staged files
STAGED_FILES=$(git diff --cached --name-only)
if [ -n "$STAGED_FILES" ]; then
  for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
      if grep -iE '(password|secret|api_key|token).*=.*[a-zA-Z0-9]{16,}' "$FILE" | grep -vE '(example|placeholder|CHANGE_ME|YOUR_)' || true; then
        # Check if actual matches occurred without triggering exit on no match
        MATCHES=$(grep -iE '(password|secret|api_key|token).*=.*[a-zA-Z0-9]{16,}' "$FILE" | grep -vE '(example|placeholder|CHANGE_ME|YOUR_)')
        if [ -n "$MATCHES" ]; then
          echo "WARNING: Potential secret found in $FILE"
          echo "Please review before committing. To bypass, use --no-verify."
          exit 1
        fi
      fi
    fi
  done
fi

echo "Pre-commit checks passed."
exit 0
